# 数据链路层

标签（空格分隔）： 前端知识体系

---

在单个网络中将数据从一台主机传送到另一台主机

## 数据处理

### 封装成帧

在一段数据的前后分别添加首部和尾部，构成数据链路层的协议数据单元-帧

* 帧首部：帧定界符、控制信息
* 帧数据：传送的数据，小于最大传送单元MTU（Maximum Transfer Unit）
* 帧尾部：帧检验序列、帧定界符

### 透明传输

传送的数据按照原样没有差错的通过数据链路层

* 发送端对数据中出现的帧定界符使用转义符进行字节填充
* 接收端在将填充后的数据恢复成填充前

### 差错检测

对传输的帧进行比特检测

* 发送端生成帧检验序列FCS（Frame Check Sequence）
* 接收端使用循环冗余检验CRC（Cyclic Redundancy Check）检测比特差错

## PPP协议

Point-to-Point Protocol，点对点协议，用户与ISP进行通信时使用的数据链路层协议

* LCP：Link Control Protocol，链路控制协议，用于建立、配置、测试连接
* NCP：Network Control Protocol，网络控制协议，支持网络层协议

### 帧格式

* 标志字段F: 0x7E，帧定界符
* 地址字段A：0xFF，目前无意义
* 控制字段C：0x03，目前无意义
* 协议字段：2字节，0x0021（IP数据）、0xC021（LCP数据）、0x8021（NCP数据）
* 数据字段：不超过1500字节
* 帧检验系列FCS
* 标志字段F: 0x7E，帧定界符

### 流程

* 建立LCP链接
* 协商LCP配置
* 鉴权
 * PAP：Password Authentication Protocol，使用用户名和密码鉴权
 * CHAP：Challenge-Handshake Authentication Protocol，使用随机数和密码计算成的hash值鉴权
* 协商NCP配置
* 传输网络层数据

## 网络适配器

网卡，计算机通过适配器与外界局域网相连

* 通过I/O总线以并行传输的方式与计算机通信
* 通过电缆或双绞线以串行传输的方式与局域网通信

### MAC地址

适配器地址，固化在适配器的ROM中，用6字节表示

* 第1位：单播地址（0）/ 多播地址（1）
* 第2位：全局地址（0）/ 本地地址（1）
* 第3~24位：厂商识别码
* 第25~48位：厂商内识别码

### 过滤

检测是否是发往本站的帧

* 单播帧：一对一，收到的帧的MAC地址与本站的硬件地址相同
* 广播帧：一对全体，发送给本局域网上所有站点的帧
* 多播帧：发送给本局域网上一部分站点的帧

### 混杂方式

只要有帧在以太网上传输就悄悄接收下来

## 以太网

使用最广的局域网，采用一对多的广播通信

* 总线型
* 星形
* 环形

### 帧格式

* 目的地址字段：目的站的MAC地址
* 源地址字段：当前站的MAC地址
* 类型：上层协议类型，0x0800（IP数据报）
* 数据字段：46到1500字节
* 帧检验序列FCS

向下传到物理层时插入了8个字节

* 前同步码：7个字节，用于接收端的适配器同步发送端的时钟
* 帧开始定界符

### CSMA/CD协议

Carrier Sense Multiple Access with Collsion Detection，载波监听多点接入/碰撞检测，总线型网络的数据链路层协议

* 准备发送：适配器从网络层获得一个分组，封装成以太网帧，放入适配器缓存中
* 检测信道：检测到信道空闲，且在96比特时间内保持空闲（保证帧最小间隔），发送帧
* 碰撞检测：发送帧的过程中继续检测信道
 * 在争用期内未检测到碰撞，帧发送成功
 * 在争用期内检测到碰撞，立即停止发送数据并发送人为干扰信号，接着执行指数退避算法，等待随机个争用期时间后重新发送帧，重传16次仍未成功时向上报错

### 极限信道利用率

碰撞检测下信道利用率受端到端时延和帧发送时间的影响

* 以太网单程端到端时延越小，极限信道利用率越大
* 以太网帧发送时间越长，极限信道利用率越大

### 集线器方式

多接口转发器，在物理层简单的转发比特

* 每个站通过一根电缆内的两对双绞线（分别用于发送和接收）与集线器的接口相连，形成星形拓扑
* 使用集线器的以太网逻辑上仍是个总线网，仍使用CSMA/CD协议

### 令牌环方式

沿着令牌环发送令牌报文

1. 接收到令牌的主机可以发送数据
2. 下一个主机根据MAC地址判断是否是目标主机
 a. 不是目标主机，将数据转给下一个主机
 b. 是目标主机，接收数据，并设置为已接收转给下一个主机
3. 数据回到源主机后被丢弃，令牌传递给下一个主机

## 拓展以太网

### 物理层拓展

* 站与集线器之间使用光纤和光纤调制解调器相连
* 使用多个集线器练成更大的以太网

### 数据链路层拓展

使用以太网交换机转发帧，以全双工方式工作，不使用CSMA/CD协议

* 源主机将数据发送给交换机
* 交换机将源MAC地址和对应的接口记录到转发表中
* 交换机在转发表中查找目标MAC地址的接口
 * 未找到，向其他主机广播
 * 已找到，通过该接口转发给目标主机

### 虚拟局域网

在以太网帧的源地址字段和类型字段之间插入一个4字节的VLAN标识，用来指明发送该帧的计算机属于哪一个虚拟局域网

* 前两个字节：0x8100，标记类型
* 后两个字节
 * 前三位：用户优先级字段
 * 第四位：规范格式指示符CFI
 * 后十二位：VLAN ID

## 高速以太网

* 100Base-T以太网
* 吉比特以太网
* 10吉比特以太网及更快的以太网

### 特点

* 仍保持以太网帧格式和最小、最大帧长
* 采用全双工、半双工传输方式
* 铜缆、双绞线、光纤等多种媒介

## PPPoE

在以太网上运行PPP，宽带上网使用的链路层协议

* MAC首部
* PPPoE首部
* PPP首部
* PPP数据
* FCS
