# 数据链路层

标签（空格分隔）： 前端知识体系

---

在单个网络中将数据从一台主机传送到另一台主机

## 封装成帧

在上层数据的前后分别添加首部和尾部，构成帧

* 帧首部：帧定界符、控制信息
* 帧数据：上层数据
 * 小于最大传送单元MTU
 * 对数据中出现的帧定界符转义
* 帧尾部：帧检验序列FCS、帧定界符
 * 接收端可以通过FCS检测比特差错

## 网络适配器

网卡，计算机通过适配器与局域网相连

* 混杂方式：接收以太网上广播的帧，不管是否是发往本站的
* 过滤：通过MAC地址检测是否是发往本站的帧

### MAC地址

适配器地址，固化在适配器的ROM中，用6字节表示

* 第1位：单播地址（0）/ 多播地址（1）
* 第2位：全局地址（0）/ 本地地址（1）
* 第3~24位：厂商识别码
* 第25~48位：厂商内识别码

## 以太网

使用最广的局域网，采用一对多的广播通信

### 帧格式

* 首部
 * 目的地址字段：目的站的MAC地址
 * 源地址字段：当前站的MAC地址
 * 类型：上层协议类型，0x0800（IP数据报）
* 数据
 * 数据字段：46到1500字节
* 尾部
 * 帧检验序列FCS

向下传到物理层时插入了8个字节

* 前同步码：7个字节，用于接收端的适配器同步发送端的时钟
* 帧开始定界符：1个字节，标识帧的开始

### CSMA/CD协议

Carrier Sense Multiple Access with Collsion Detection，载波监听多点接入/碰撞检测，总线型网络的数据链路层协议

* 准备发送：适配器从网络层获得一个分组，封装成以太网帧，放入适配器缓存中
* 检测信道：检测到信道空闲，且在96比特时间内保持空闲（保证帧最小间隔），发送帧
* 碰撞检测：发送帧的过程中继续检测信道
 * 在争用期内未检测到碰撞，帧发送成功
 * 在争用期内检测到碰撞，立即停止发送数据并发送人为干扰信号，接着执行指数退避算法，等待随机个争用期时间后重新发送帧，重传16次仍未成功时向上报错

### 集线器方式

多接口转发器，在物理层简单的转发比特

* 每个站通过一根电缆内的两对双绞线（分别用于发送和接收）与集线器的接口相连，形成星形拓扑
* 使用集线器的以太网逻辑上仍是个总线网，仍使用CSMA/CD协议

### 交换机方式

根据交换机的转发表在以太网内转发帧，以全双工方式工作，不使用CSMA/CD协议

* 源主机将数据发送给交换机
* 交换机将源MAC地址和对应的接口记录到转发表中
* 交换机在转发表中查找目标MAC地址的接口
 * 未找到，向其他主机广播
 * 已找到，通过该接口转发给目标主机

## PPP协议

Point-to-Point Protocol，点对点协议，用户与ISP进行通信时使用的数据链路层协议

* LCP：Link Control Protocol，链路控制协议，用于建立、配置、测试连接
* NCP：Network Control Protocol，网络控制协议，支持网络层协议

### 帧格式

* 首部
 * 标志字段F: 0x7E，帧定界符
 * 地址字段A：0xFF，目前无意义
 * 控制字段C：0x03，目前无意义
 * 协议字段：2字节，0x0021（IP数据）、0xC021（LCP数据）、0x8021（NCP数据）
* 数据
 * 数据字段：不超过1500字节
* 尾部
 * 帧检验系列FCS
 * 标志字段F: 0x7E，帧定界符

### 流程

* 建立LCP链接
* 协商LCP配置
* 鉴权
 * PAP：Password Authentication Protocol，使用用户名和密码鉴权
 * CHAP：Challenge-Handshake Authentication Protocol，使用随机数和密码计算成的hash值鉴权
* 协商NCP配置
* 传输网络层数据

## PPPoE

在以太网上运行PPP，宽带上网使用的链路层协议

* MAC首部
* PPPoE首部
* PPP首部
* PPP数据
* FCS
