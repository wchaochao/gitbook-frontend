# SSH

标签（空格分隔）： 前端知识体系

---

## 介绍

Secure Shell，安全网络协议，用于替代非安全的Telnet等远程Shell协议

* 数据通信安全
* 远程登录
* 远程指令执行

### 协议架构

* 传输层协议：负责认证服务器、加密数据、确保数据完整性
* 用户认证协议：认证使用者是否是ssh服务器的用户
* 连接协议：将加密的信息隧道复用成若干个逻辑通道，提供给更高层的应用协议使用

### 软件组成

* ssh client：SSH客户端
* ssh server：SSH服务器端

## 安全传输

### 加密

防止数据内容泄露

* 对称加密：使用一个密钥进行加密/解密，如DES、3DES、AES算法
* 非对称加密：使用公钥/私钥对进行加密/解密，如RSA、DSA算法

### 签名

验证数据的完整性，防止被篡改

* 消息摘要：使用MD5、SHA等哈希算法对一段信息生成消息摘要
* 数字签名：对消息摘要进行加密

### 认证

防止中间人攻击，避免被冒充

* CA：证书中心，为公钥做认证
* 数字证书：CA使用私钥将申请人的公钥和相关信息加密，生成数字证书

## 传输阶段

### 发起连接

* 服务器启动SSH服务，等待客户端连接
* 客户端向服务器端的SSH端口（默认为22）发送TCP请求

### 版本协商

* 服务器将自己的SSH协议版本发送给客户端，格式为`SSH-<version>-<software>`
* 客户端接收到报文后，解析出SSH协议版本，将自己决定使用的SSH协议版本发送给服务器端

### 算法协商

* 服务器发送Host Key（主机公钥）、Server Key（临时非对称公钥）、随机数检测字节和服务器端支持的加密算法、压缩方式、认证方式给客户端
* 客户端查询known_hosts文件，若Host Key不在known_hosts文件中，则需要提示用户是否信任该主机
* 客户端发送自己支持的公钥算法列表、加密算法列表、MAC算法列表、压缩算法列表给客户端，协商出使用的算法

### 密钥协商

* 服务器端生成会话ID，发送给客户端
* 客户端生成会话密钥，与会话ID进行异或运算，使用主机公钥加密后发送给服务器端
* 服务器端使用私钥解密，与会话ID进行异或运算得到会话密钥

## 认证阶段

### 口令认证

* 客户端使用会话密钥对用户名和密码加密，发送给服务器端
* 服务器端使用会话密钥解密用户名和密码，验证是否合法

### 公钥认证

* 客户端事先将自己的公钥上传到服务器端的authorized_keys文件中
* 客户端使用会话密钥加密公钥信息发送给服务器端
* 服务器端解密后在authorized_keys文件中查找到客户端的公钥，生成一个随机数，使用该公钥加密，再用会话密钥加密后发送给客户端
* 客户端使用会话密钥、私钥解密出随机数，将随机数和会话ID结合生成一个哈希值，用会话密钥加密后发送给服务器端
* 服务器端用同样的方式生成哈希值，与客户端的对比

### 会话请求阶段

* 认证通过后，客户端向服务器端发送会话请求
* 服务器处理客户端的请求，返回成功或失败响应

## 交互会话阶段

* 客户端将要执行的命令加密后发送给服务器端
* 服务器端解密并执行命令，将命令的结果加密后发送给客户端
* 客户端解密命令结果输出到屏幕上
